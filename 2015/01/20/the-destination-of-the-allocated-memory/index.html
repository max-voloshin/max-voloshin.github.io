<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The destination of the allocated memory &mdash; Max Voloshin</title>
    <link href="https://fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/assets/main.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/images/mv.jpg"/>
    <link href="/feed.xml" rel="alternate" type="application/rss+xml" title="Max Voloshin" />
    <meta name="title" content="The destination of the allocated memory ">
    <link rel="canonical" href="http://maxvoloshin.com/2015/01/20/the-destination-of-the-allocated-memory/">
     
           
    <meta property="og:title" content="The destination of the allocated memory "/>
    <meta property="og:url" content="http://maxvoloshin.com/2015/01/20/the-destination-of-the-allocated-memory/"/>
    
    
    <meta property="og:description" content="The missed feature of PHP profilers"/>
    <meta name="description" content="The missed feature of PHP profilers"/>
    
    <meta property="og:site_name" content="Max Voloshin">     
</head>
<body>
<div class="cover" style="background-image:url(/images/blog-cover.jpg)">
    <a href="/about/" class="btn btn-outline">About me</a>
    <a href="/" class="logo">
        <img src="/images/mv.jpg" alt="Max Voloshin">
    </a>
    <div class="social-bucket">
        <a class="social" href="https://twitter.com/maxvoloshindev" title="Follow on Twitter" target="_blank">
            <i class="icon icon-twitter"></i>
        </a>
        <a class="social" href="https://github.com/max-voloshin" title="Watch on Github" target="_blank">
            <i class="icon icon-github"></i>
        </a>
        <a class="social" href="http://facebook.com/MaxVoloshin" title="Like on Facebook" target="_blank">
            <i class="icon icon-facebook"></i>
        </a>
        <a class="social" href="https://www.linkedin.com/pub/max-voloshin/95/aba/507" title="Connect on LinkedIn" target="_blank">
            <i class="icon icon-linkedin"></i>
        </a>
        <a class="social" href="/feed.xml" title="RSS Feed">
            <i class="icon icon-rss"></i>
        </a>
    </div>
</div>
<article>

    <div class="container">
        <header>
            <div class="meta">
                <!--By <address><a rel="author" href="" title="" target="_blank"></a></address> &mdash;-->
                <time pubdate datetime="2015-20-January" title="January 20, 2015">January 20, 2015</time>
            </div>
            <h1 class="title">The destination of the allocated memory</h1>
            <h2 class="subtitle">The missed feature of PHP profilers</h2>
        </header>

        <section>
            <p><strong>Disclaimer</strong>: <em>I am not an expert of PHP internals and I don’t know the chances of this feature to be implemented, but as any developer I am optimistic and open for dreams :)</em></p>

<p>2014 was a really lucky year for PHP developers worrying about performance of their applications. Two new profilers were launched: <a href="https://blackfire.io/">Blackfire by SensioLabs</a> and <a href="https://qafoolabs.com/">Qafoo profiler</a>. Both of them are really interesting inheritors of <a href="http://pecl.php.net/package/xhprof">Xhprof</a> because they represent old-known facts in efficient manner and provide helpful feedback to developers.</p>

<p>In December Blackfire team introduced the brand new feature: tallying <a href="http://blog.blackfire.io/performance-impact-of-the-php-garbage-collector.html">the spent time of garbage collector</a>. It gives the missed knowledge about unobvious activity of PHP to developers.</p>

<p>Today I want to make the public request of another missed feature: <strong>destination of the allocated memory</strong>.</p>

<p>Existent profilers work in terms of a stack trace. This approach helps to discover problems with execution time of an application because of CPU and IO activities. But when you try to detect memory leaks it’s hard to do that in such terms. Developer receives information about a context (a function or a method) when memory is allocated, but there is no chance to see its destination. This understanding is crucial when you work with complex applications where memory is being allocated and freed many times (especially in long running CLI scripts). Thus a profiler gives you a lot of information that doesn’t help you to understand where the allocated memory is <strong>accumulated</strong> during request.</p>

<p>When I work with PHP applications I assume that all possible destinations may be classified by three categories.</p>

<h2 id="1_system_memory">#1 System memory</h2>

<p>Memory is accumulated in the PHP core itself or its extensions. There is nothing to do with your application, so you should update PHP (every next version of PHP is more efficient) or update / tune / remove some of extensions.</p>

<p><strong>Expected report format</strong>:</p>

<ul>
<li>core – x<sub>0</sub> Mb, y<sub>0</sub>%</li>

<li>ext1 – x<sub>1</sub> Mb, y<sub>1</sub>%</li>

<li>ext2 – x<sub>2</sub> Mb, y<sub>2</sub>%</li>

<li>…</li>
</ul>

<h2 id="2_blocked_memory">#2 Blocked memory</h2>

<p>Your application works properly, but some of data was removed from the application and wasn’t removed from memory because of cyclic dependencies. This issue may be resolved by garbage collector automatically or direct calling of <code>gc_collect_cycles</code>. You should decide which approach is best for your application.</p>

<p><strong>Expected report format</strong>: blocked memory – x Mb, y%</p>

<h2 id="3_busy_memory">#3 Busy memory</h2>

<p>You should explore a report of your application’s memory usage for possible anomalies in terms of PHP entities (global variables / class fields / object properties). This part is the most valuable because it provides clear understanding about memory usage of the application by its components for the developer.</p>

<p><strong>Expected report format</strong>:</p>

<ul>
<li>Global variables:
<ul>
<li><code>$_SERVER</code> – x<sub>0</sub> Mb, y<sub>0</sub>%</li>

<li><code>$_GET</code> – x<sub>1</sub> Mb, y<sub>0</sub>%</li>

<li>…</li>
</ul>
</li>

<li>Class fields:
<ul>
<li><code>SomeClass::$property</code> – k<sub>0</sub> Mb, m<sub>0</sub>%</li>

<li><code>AnotherClass::$property</code> – k<sub>1</sub> Mb, m<sub>1</sub>%</li>

<li>…</li>
</ul>
</li>

<li>Object properties:
<ul>
<li><code>Id0@SomeClass-&gt;$property</code> – z<sub>0</sub> Mb, q<sub>0</sub>%</li>

<li><code>Id1@SomeClass-&gt;$property</code> – z<sub>1</sub> Mb, q<sub>1</sub>%</li>

<li>…</li>
</ul>
</li>
</ul>

<p><code>Id0</code> and <code>Id1</code> are object’s identifiers for splitting information about objects of the same class. It would be awesome if <code>{Concrete}</code> profiler will provide <code>{Concrete}ProfilerObjectInterface</code> with <code>get{Concrete}ProfilerIdentifier</code> method for defining custom identifier.</p>

<p>I realize that different variables may refer to the same memory (because of PHP object model), so sum of memory usage may be greater than 100%. In other words these values answer the question “How much memory will be busy if other variables are removed”.</p>

<p>Unfortunately none of current tools give such information, otherwise let me know about it!</p>

<p>Happy to discuss the proposed feature in comments.</p>

<p><strong>UPD #1</strong>: Qafoo profiler team:</p>
<blockquote class='twitter-tweet' data-conversation='none'><p><a href='https://twitter.com/maxvoloshindev'>@maxvoloshindev</a> very interesting request and I wished to have this myself sometimes. Unfortunately we are not working on this atm.</p>&mdash; Benjamin Eberlei (@beberlei) <a href='https://twitter.com/beberlei/status/557646709430681601'>January 20, 2015</a></blockquote>
<p><strong>UPD #2</strong>: The author of <a href="https://github.com/BitOne/php-meminfo">PHP Meminfo</a> extension:</p>
<blockquote class='twitter-tweet' data-conversation='none'><p><a href='https://twitter.com/maxvoloshindev'>@maxvoloshindev</a> Your blog post seems like extracted from my head ;) I was missing the Java jmap tools, so I did a similar one on in PHP.</p>&mdash; Benoit Jacquemont (@BJacquemont) <a href='https://twitter.com/BJacquemont/status/557926441959292928'>January 21, 2015</a></blockquote>
<p>I will digest this extension and give feedback about it soon.</p>
            <div class="social">
    <div>
        <a href="https://twitter.com/share" class="twitter-share-button"  data-text="The destination of the allocated memory" data-related="maxvoloshindev">Tweet</a>
    </div>
    <div>
        <div class="fb-like" data-width="150" data-layout="button_count" data-action="like" data-show-faces="true" data-send="false"></div>
    </div>
</div>
        </section>

        <!--<footer>
            <address>
               
                <p>Written by <strong><a rel="author" href="https://twitter.com/" title="" target="_blank"></a></strong><br>
                <span class="muted"></span>
                </p>
            </address>

        </footer>-->

        
        <section>
            <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'maxvoloshin'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
        </section>
        
    </div>
</article>

<div class="site-footer">
    <div class="container">
    Blog theme inspiration: <a href="https://github.com/kippt/jekyll-incorporated/">Jekyll Incorporated</a>
    <br>
    Cover photo: Dnipropetrovsk, Ukraine. Photographer: Avilov Alexandr
    </div>
</div>
<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="/assets/main.js"></script>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=253595308025739";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-55921457-1', 'auto');
    ga('send', 'pageview');
</script>


</body>
</html>
